{% extends "Base.html" %}
{% block title %}Chat - Vora EX{% endblock %}
{% block content %}

<!-- Quitar padding del container y expandir a full width -->
<style>
  .container {
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  body {
    overflow: hidden;
  }
</style>

<div style="display: flex; height: calc(100vh - 100px); margin: 0; padding: 0; overflow: hidden; width: 100vw;">
  
  <!-- SIDEBAR IZQUIERDO -->
  <!-- SIDEBAR IZQUIERDO CON SCROLL -->
  <aside style="
    width: 220px;
    background: var(--glass);
    backdrop-filter: var(--blur-level) saturate(180%);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    padding: 20px 16px;
    /* overflow-y: auto; PERMITE SCROLL */
    max-height: calc(100vh - 100px);  /* ALTURA MÃXIMA */
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
  ">
    
    <!-- BotÃ³n Nuevo Chat -->
    <a href="{{ url_for('nuevo_chat') }}" style="
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 24px;
      background: var(--glass);
      backdrop-filter: var(--blur-level) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 18px;
      color: var(--text) !important;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.92rem;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      letter-spacing: -0.3px;
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.08),
        inset 0 1px 1px rgba(255, 255, 255, 0.6);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    " onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.background='rgba(255, 255, 255, 0.35)';" 
       onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.background='var(--glass)';">
       Nuevo chat
    </a>

    <!-- Historial de conversaciones -->
    <div style="margin-bottom: 20px; flex: 1; overflow-y: auto;">
      <h4 style="
        margin: 0 0 12px 8px;
        font-size: 0.75rem;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      ">Conversaciones</h4>
      
      {% if chats_anteriores %}
        {% for chat in chats_anteriores %}
          <a href="{{ url_for('cargar_chat', chat_id=chat.id) }}" style="
            display: block;
            padding: 12px 14px;
            margin-bottom: 6px;
            border-radius: 14px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--text);
            text-decoration: none;
            font-size: 0.88rem;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.transform='translateX(4px)';" 
             onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.08)'; this.style.transform='translateX(0)';">
            ðŸ’¬ {{ chat.titulo[:30] }}...
          </a>
        {% endfor %}
      {% else %}
        <p style="
          padding: 16px 12px;
          text-align: center;
          color: var(--muted);
          font-size: 0.85rem;
          font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        ">No hay conversaciones previas</p>
      {% endif %}
    </div>

    <!-- Separador -->
    <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 20px 0;"></div>

    <!-- Botones de acciÃ³n -->
    <a href="{{ url_for('descargar_historial') }}" style="
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 10px;
      background: var(--glass);
      backdrop-filter: var(--blur-level) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 14px;
      color: var(--text) !important;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.88rem;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      letter-spacing: -0.2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-1px)'; this.style.background='rgba(255, 255, 255, 0.25)';" 
      onmouseout="this.style.transform='translateY(0)'; this.style.background='var(--glass)';">
      <img src="{{ url_for('static', filename='imagenes/descar1.png') }}" alt="descargar" style="width: 18px; height: 18px; object-fit: contain;">
      Descargar
    </a>
    
    <form method="POST" action="{{ url_for('borrar_historial') }}" style="margin: 0 0 20px 0;">
      <button type="submit" style="
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          width: 100%;
          padding: 12px 16px;
          background: var(--glass);
          backdrop-filter: var(--blur-level) saturate(180%);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 14px;
          color: var(--text) !important;
          font-weight: 600;
          font-size: 0.88rem;
          font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
          letter-spacing: -0.2px;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          transition: all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-1px)'; this.style.borderColor='rgba(255, 68, 68, 0.5)';" 
          onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255, 100, 100, 0.3)';">
          <img src="{{ url_for('static', filename='imagenes/basura.png') }}" alt="borrar" style="width: 18px; height: 18px; object-fit: contain;">
          Borrar todo
        </button>
    </form>

    <!-- Card de usuario -->
    <div style="
      background: var(--glass);
      backdrop-filter: var(--blur-level) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    ">
      <p style="
        margin: 0 0 6px 0;
        font-size: 0.7rem;
        color: var(--muted);
        font-weight: 500;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      ">Conectado como</p>
      
      <h4 style="
        margin: 0 0 4px 0;
        font-size: 0.95rem;
        color: var(--text);
        font-weight: 700;
        letter-spacing: -0.3px;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      ">{{ user.nombre }}</h4>
      
      <small style="
        color: var(--muted);
        font-size: 0.8rem;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      ">{{ user.email }}</small>
    </div>
  </aside>

  <!-- ÃREA PRINCIPAL DEL CHAT -->
  <main style="
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg);
  ">
    
    <!-- HEADER CON LOGO -->
    <header style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: var(--card);
      backdrop-filter: var(--blur-level) saturate(180%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    ">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="{{ url_for('static', filename='imagenes/logo.png') }}" alt="Vora EX" style="
          width: 36px;
          height: 36px;
          border-radius: 10px;
        ">
        <h1 style="
          margin: 0;
          font-size: 1.5rem;
          color: transparent;
          background-clip: text;
          -webkit-background-clip: text;
          background-image: var(--accent);
          font-weight: 800;
          letter-spacing: -0.8px;
          font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        ">Vora EX</h1>
      </div>
    </header>

    <!-- VENTANA DE CHAT -->
    <div id="chat-window" style="
      flex: 1;
      overflow-y: auto;
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      
    ">
      {% if historial %}
        {% for m in historial %}
          <div style="
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 20px 20px 4px 20px;
            margin-bottom: 16px;
            margin-left: auto;
            background: var(--card);
            backdrop-filter: var(--blur-level) saturate(180%);
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
            box-shadow: 0 4px 16px rgba(168, 47, 148, 0.25);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            letter-spacing: -0.2px;
          ">{{ m.mensaje }}</div>
          
          <div style="
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 20px 20px 20px 4px;
            margin-bottom: 16px;
            background: var(--bg);
            backdrop-filter: var(--blur-level) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
            box-shadow: 
              0 4px 16px rgba(0, 0, 0, 0.08),
              inset 0 1px 1px rgba(255, 255, 255, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            letter-spacing: -0.2px;
          ">{{ m.respuesta }}</div>
        {% endfor %}
      {% else %}
        <div id="placeholder" style="
          margin: auto;
          text-align: center;
          color: var(--muted);
          padding: 60px 40px;
        ">
          <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.6;">ðŸ’¬</div>
          <h2 style="
            margin: 0 0 12px 0;
            font-size: 1.4rem;
            color: var(--text);
            font-weight: 700;
            letter-spacing: -0.5px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
          ">Â¿En quÃ© puedo ayudarte?</h2>
          <p style="
            margin: 0;
            font-size: 0.95rem;
            color: var(--muted);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
          ">Escribe un mensaje para comenzar</p>
        </div>
      {% endif %}
    </div>

    <!-- BARRA DE ENTRADA CON ADJUNTAR -->
    <div style="
      padding: 20px 32px 24px;
      background: var(--card);
      backdrop-filter: var(--blur-level) saturate(180%);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    ">
      <form id="chat-form" method="POST" action="{{ url_for('chat') }}" enctype="multipart/form-data" style="
        max-width: 900px;
        margin: 0 auto;
      ">
        <div style="
          display: flex;
          align-items: center;
          background: var(--glass);
          backdrop-filter: var(--blur-level) saturate(150%);
          border: 1px solid rgba(255, 255, 255, 0.25);
          border-radius: 26px;
          padding: 6px 8px 6px 12px;
          box-shadow: 
            0 6px 24px rgba(0, 0, 0, 0.12),
            inset 0 1px 2px rgba(255, 255, 255, 0.3);
          transition: all 0.3s ease;
        ">
          <!-- BotÃ³n adjuntar -->
          <label for="file-upload" style="
            cursor: pointer;
            padding: 8px;
            margin-right: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)';" 
             onmouseout="this.style.background='transparent';" title="Adjuntar archivo">
            ðŸ“Ž
          </label>
          <input type="file" id="file-upload" name="archivo" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.png">
          
          <input id="mensaje" name="mensaje" type="text" placeholder="Escribe tu mensaje..." required style="
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 0.95rem;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            letter-spacing: -0.2px;
            outline: none;
          " onfocus="this.parentElement.style.borderColor='rgba(168, 47, 148, 0.4)'; this.parentElement.style.boxShadow='0 8px 32px rgba(168, 47, 148, 0.15), inset 0 1px 2px rgba(255, 255, 255, 0.3)';"
             onblur="this.parentElement.style.borderColor='rgba(255, 255, 255, 0.25)'; this.parentElement.style.boxShadow='0 6px 24px rgba(0, 0, 0, 0.12), inset 0 1px 2px rgba(255, 255, 255, 0.3)';">

          <button type="submit" style="
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--bg);
            backdrop-filter: var(--blur-level) saturate(180%); 
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            color: white !important;
            font-weight: 600;
            font-size: 0.92rem;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            letter-spacing: -0.3px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(168, 47, 148, 0.35);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          " onmouseover="this.style.transform='scale(1.05) translateY(-1px)'; this.style.boxShadow='0 6px 24px rgba(168, 47, 148, 0.45)';" 
            onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 4px 16px rgba(168, 47, 148, 0.35)';">
            <img src="{{ url_for('static', filename='imagenes/enviar.png') }}" alt="enviar" style="width: 18px; height: 18px; object-fit: contain;">
            Enviar
          </button>
        </div>
      </form>
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('chat-form');
  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('mensaje');
  let placeholder = document.getElementById('placeholder');

  input.addEventListener('input', () => {
    if (input.value.trim() !== '' && placeholder) {
      placeholder.remove();
      placeholder = null;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const mensaje = input.value.trim();
    if (!mensaje) return;

    if (placeholder) {
      placeholder.remove();
      placeholder = null;
    }

    input.value = '';

    const userDiv = document.createElement('div');
    userDiv.style.cssText = `
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 20px 20px 4px 20px;
      margin-bottom: 16px;
      margin-left: auto;
      background: linear-gradient(135deg, #a82f94, #7c3aed);
      color: white;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: 0 4px 16px rgba(168, 47, 148, 0.25);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      letter-spacing: -0.2px;
    `;
    userDiv.textContent = mensaje;
    chatWindow.appendChild(userDiv);

    const resp = await fetch('{{ url_for("api_chat") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensaje })
    });

    const data = await resp.json();

    const botDiv = document.createElement('div');
    botDiv.style.cssText = `
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 20px 20px 20px 4px;
      margin-bottom: 16px;
      background: var(--glass);
      backdrop-filter: var(--blur-level) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text);
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.08),
        inset 0 1px 1px rgba(255, 255, 255, 0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      letter-spacing: -0.2px;
    `;
    botDiv.innerHTML = data.respuesta.replace(/\n/g, '<br>');
    chatWindow.appendChild(botDiv);

    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
});
</script>

{% endblock %}