{% extends "Base.html" %}
{% block title %}Chat - Recomombot{% endblock %}
{% block content %}
  <div class="chat-layout">
    <aside class="chat-sidebar">
      <div class="user-card">
        <p>Conectado como</p>
        <h3>{{ user.nombre }}</h3>
        <small>{{ user.email }}</small>
      </div>      
      <a href="{{ url_for('descargar_historial') }}" class="btn btn-download">Descargar historial</a>
      <form method="POST" action="{{ url_for('borrar_historial') }}" class="delete-form">
        <button type="submit" class="btn btn-delete">Borrar historial</button>
      </form>
    </aside>

<section class="chat-main">
  <div id="chat-window" class="chat-window">
    {% if historial %}
      {% for m in historial %}
        <div class="bubble user">{{ m.mensaje }}</div>
        <div class="bubble bot">{{ m.respuesta }}</div>
      {% endfor %}
    {% else %}
      <div id="placeholder" class="placeholder">AÃºn no tienes mensajes. Escribe algo...</div>
    {% endif %}
  </div>
      
  <form id="chat-form" class="chat-form" method="POST" action="{{ url_for('chat') }}">
    <input id="mensaje" name="mensaje" type="text" placeholder="Escribe tu mensaje..." required>
    <button class="btn" type="submit">Enviar</button>
  </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('chat-form');
  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('mensaje');
  let placeholder = document.getElementById('placeholder');


  input.addEventListener('input', () => {
    if (input.value.trim() !== '' && placeholder) {
      placeholder.remove();
      placeholder = null;
    }
  });

 
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const mensaje = input.value.trim();
    if (!mensaje) return;

   
    if (placeholder) {
      placeholder.remove();
      placeholder = null;
    }

    input.value = '';

 
    const userDiv = document.createElement('div');
    userDiv.className = 'bubble user';
    userDiv.textContent = mensaje;
    chatWindow.appendChild(userDiv);

  
    const resp = await fetch('{{ url_for("api_chat") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensaje })
    });

    const data = await resp.json();

 
    const botDiv = document.createElement('div');
    botDiv.className = 'bubble bot';
    botDiv.innerHTML = data.respuesta.replace(/\n/g, '<br>');
    chatWindow.appendChild(botDiv);

    chatWindow.scrollTop = chatWindow.scrollHeight;
  });
});
</script>

{% endblock %}

